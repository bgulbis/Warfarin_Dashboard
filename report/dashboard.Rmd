---
title: "Warfarin Dosing Service"
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)
library(edwr)
library(dplyr)
library(tidyr)
library(stringr)
library(lubridate)
library(dygraphs)
library(xts)
library(RColorBrewer)
library(plotly)

data.raw <- "../data/raw"

date.start <- c("2016-01-01", "2016-06-30")

# get all warfarin and consult orders
data.orders <- read_data(data.raw, "orders") %>%
    as.order_by() %>%
    filter(action.type == "Order") %>%
    mutate(action.date = floor_date(action.datetime, unit = "day"),
           consult = !str_detect(order, "^warfarin$"))

# make tidy data set
df <- data.orders %>%
    distinct(pie.id, action.date, consult) %>%
    group_by(pie.id, action.date) %>%
    mutate(value = TRUE,
           consult = if_else(consult == TRUE, "consult", "warfarin")) %>%
    spread(consult, value) %>%
    mutate(warfarin = if_else(consult == TRUE & is.na(warfarin), TRUE, warfarin)) %>%
    gather(order, value, consult, warfarin) %>%
    filter(!is.na(value)) %>%
    group_by(pie.id, action.date, order) %>%
    summarize(n = n()) %>%
    group_by(action.date, order) %>%
    summarize(n = n()) %>%
    spread(order, n) %>%
    mutate(warfarin = if_else(is.na(consult), warfarin, warfarin - consult)) %>%
    gather(order, n, -action.date) %>%
    mutate(n = coalesce(n, 0L)) %>%
    spread(order, n) 

ts <- as.matrix(df[, 2:3]) %>% 
    as.xts(order.by = df$action.date, tzone = "US/Central")

dyg <- dygraph(ts, main = "Daily Warfarin Orders") %>%
    dySeries("consult", label = "Pharmacy") %>%
    dySeries("warfarin", label = "Traditional") 
```

Utilization
========================================================

### Utilization of Pharmacy Warfarin Dosing Service

```{r}
dyg %>%
    dyOptions(colors = brewer.pal(3, "Set1")) %>%
    dyRoller(rollPeriod = 15) %>%
    dyRangeSelector()
```

> Data presented as the average over a rolling period of days (default is 15). The rolling period can be adjusted using the text box in the lower left corner of the figure. Set the value to 1 to show individual daily values. Adjust the time period being displayed using the selector at the bottom of the figure.

Totals
========================================================

### Total Daily Utilization of Warfarin

```{r}
dyg %>%
    dyOptions(stackedGraph = TRUE, colors = brewer.pal(3, "Set1")) %>%
    dyRangeSelector(dateWindow = date.start)
```

> Data is stacked to represent total number of daily warfarin orders during the selected time period.

Dosing
========================================================

### Initial Warfarin Dose

```{r}
ref <- data_frame(name = "warfarin", type = "med", group = "sched")

data.warfarin <- read_data(data.raw, "meds") %>%
    as.meds_sched() %>%
    tidy_data(ref = ref) %>%
    group_by(pie.id) 

warf.duration <- data.warfarin %>%
    summarize(warf.start = first(med.datetime),
              warf.stop = last(med.datetime))

warf.doses <- data.warfarin %>%
    mutate(med.date = floor_date(med.datetime, "day"),
           warf.year = floor_date(med.datetime, "year"),
           warf.day = as.numeric(difftime(med.date, first(med.date), units = "days"))) %>%
    group_by(pie.id, warf.year, warf.day) %>%
    summarize(dose = sum(as.numeric(med.dose)))

ds.pts <- data.orders %>%
    filter(consult == TRUE) %>%
    distinct(pie.id) %>%
    mutate(pharmacy = TRUE)

high.dose <- warf.doses %>%
    ungroup %>%
    filter(dose > 20) %>%
    distinct(pie.id)

doses <- warf.doses %>%
    filter(!(pie.id %in% high.dose$pie.id)) %>%
    left_join(ds.pts, by = "pie.id") %>%
    mutate(group = if_else(pharmacy == TRUE, "pharmacy", "traditional", "traditional"))

first.dose <- doses %>%
    mutate(year = as.character(year(warf.year))) %>%
    group_by(pie.id, year, group) %>%
    summarize(dose = first(dose))
    
plot_ly(data = first.dose, x = group, y = dose, color = year, colors = "Set1", type = "box") %>%
    layout(boxmode = "group")
```

INR
========================================================

### Mean INR Days 1 to 10

```{r}
data.coags <- read_data(data.raw, "labs_coag") %>%
    as.labs() %>%
    select(-`Clinical Event Result Type`) %>%
    tidy_data() %>%
    inner_join(warf.duration, by = "pie.id") %>%
    filter(lab == "inr",
           lab.datetime >= floor_date(warf.start, "day") - days(1),
           lab.datetime <= ceiling_date(warf.stop, "day") + days(1)) %>%
    arrange(pie.id, lab.datetime) %>%
    mutate(warf.day = as.numeric(difftime(floor_date(lab.datetime, "day"), floor_date(warf.start, "day"), units = "days")),
           warf.year = floor_date(warf.start, "year")) %>%
    group_by(pie.id, warf.year, warf.day) %>%
    summarize(inr = max(lab.result))

inr.first <- data.coags %>%
    group_by(pie.id) %>%
    filter(warf.day <= 0) %>%
    summarize(inr.first = last(inr))

d <- data.coags %>%
    left_join(ds.pts, by = "pie.id") %>%
    mutate(group = if_else(pharmacy == TRUE, "pharmacy", "traditional", "traditional"),
           year = as.character(year(warf.year))) %>%
    # left_join(inr.first, by = "pie.id") %>%
    # mutate(inr.change = inr - inr.first) %>%
    filter(warf.day %in% 1:10) %>%
    # mutate(warf.day = as.character(warf.day)) %>%
    group_by(group, year, warf.day) %>%
    summarize(inr.mean = mean(inr, na.rm = TRUE),
              inr.sd = sd(inr, na.rm = TRUE),
              inr.sem = inr.sd / sqrt(length(inr))) %>%
    ungroup() %>%
    arrange(group, year, warf.day)
#     full_join(warf.doses, by=c("pie.id", "warf.day"))

dp <- filter(d, group == "pharmacy")
dt <- filter(d, group == "traditional")

plot_ly(data = dp, x = warf.day, y = inr.mean, color = year, name = "pharmacy", line = list(dash = "solid")) %>%
    add_trace(data = dt, 
              x = warf.day, 
              y = inr.mean, 
              color = year, 
              # error_y = list(type = "data", array = inr.sem),
              line = list(dash = "dash")) %>%
    layout(updatemenus = list(
        buttons = list(
            list(method = "restyle",
                 args = list("visible", list(TRUE, FALSE)),
                 label = "Pharmacy"),
            list(method = "restyle",
                 args = list("visible", list(FALSE, TRUE)),
                 label = "Traditional"),
            list(method = "restyle",
                 args = list("visible", list(TRUE, TRUE)),
                 label = "Both")),
        visible = TRUE
    ))

```

Dosing Data (Test)
========================================================

### Dosing Data

```{r}
    
# time series of dosing
library(zoo)
library(purrr)
warf.ts <- data.warfarin %>%
    mutate(med.date = floor_date(med.datetime, unit = "day")) %>%
    group_by(pie.id, med.date) %>%
    summarize(med.dose = sum(med.dose)) %>%
    group_by(pie.id) %>%
    do(ts = zoo(.$med.dose, order.by = .$med.date)) 
    # dmap_at("ts", ~ merge(.x, zoo(, seq(start(.x), end(.x), by = "day")), fill = 0))
    # slice_rows("pie.id") %>%
    # by_slice(map, zoo)

tsr <- map(warf.ts$ts, ~ merge(.x, zoo(, seq(start(.x), end(.x), by = "day")), fill = 0))

# zts <- zoo(wts$med.dose, order.by = wts$med.date)
# ztsreg <- merge(zts, zoo(, seq(start(zts), end(zts), by = "day")), fill = 0)

# calculate dose auc
# warf.auc <- data.warfarin %>%
#     ungroup() %>%
#     calc_runtime() 
    # summarize_data()


```

